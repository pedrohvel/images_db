name: Sync to Cloudflare KV

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      
      - env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_ID: ${{ secrets.CLOUDFLARE_KV_ID }}
        run: |
          # 1. Varredura Multimídia (Imagens, Vídeos, GIFs e Áudio)
          FILES=$(ls images/* 2>/dev/null | grep -iE '\.(jpg|jpeg|png|gif|webp|mp4|mp3)$' || echo "")
          
          if [ -z "$FILES" ]; then
            exit 0
          fi

          JSON="["
          for f in $FILES; do
            # 2. Limpeza de Título (Remove extensão e ajusta espaços)
            RAW_TITLE=$(basename "$f" | sed 's/\.[^.]*$//' | tr '_-' ' ')
            TITLE="$(echo ${RAW_TITLE:0:1} | tr '[:lower:]' '[:upper:]')${RAW_TITLE:1}"
            
            # 3. Identificação de Tipo
            case "$f" in
              *.mp4|*.webm) TYPE="video" ;;
              *.mp3|*.wav|*.ogg) TYPE="audio" ;;
              *) TYPE="image" ;;
            esac

            URL="https://cdn.jsdelivr.net/gh/${{ github.repository }}@main/$f"
            
            JSON+="{\"title\": \"$TITLE\", \"src\": \"$URL\", \"type\": \"$TYPE\"},"
          done
          JSON="${JSON%,}]"

          # 4. Injeção Remota
          npx wrangler kv key put --namespace-id=$KV_ID "catalogo" "$JSON" --remote